# Woo Alipay Profit Sharing (分账/分润) 插件说明文档

## 插件概述

**插件名称：** Woo Alipay - Profit Sharing (分账/分润)
**版本：** 0.1.0
**作者：** WooCN.com
**官网：** https://woocn.com/

这是一个为 WooCommerce 提供支付宝分账/分润功能的 WordPress 插件。该插件允许商户自动或手动地将支付宝交易金额按预设规则分配给多个收款方，支持延迟结算和即时结算两种模式。

## 系统要求

- WordPress 5.0 或更高版本
- WooCommerce 3.0 或更高版本
- Woo Alipay 插件（必须先安装并启用）
- PHP 7.4 或更高版本

## 核心功能

### 1. 分账模式
- **延迟结算（默认）：** 订单完成时自动触发分账
- **即时结算：** 支付完成时立即触发分账
- **手动结算：** 管理员可手动触发分账操作

### 2. 处理模式
- **队列模式（默认）：** 使用后台队列处理，提高性能
- **同步模式：** 立即处理，适用于需要实时反馈的场景

### 3. 分账规则配置
- **默认规则：** 应用于所有订单的基础分账比例
- **商品分类规则：** 针对特定商品分类的分账规则
- **单个商品规则：** 针对特定商品的精细化分账规则

### 4. 收款方管理
- 支持多种收款方身份类型：
  - ALIPAY_LOGON_ID（支付宝登录账号）
  - ALIPAY_USER_ID（支付宝用户ID）
- 收款方启用/禁用控制
- 自定义收款方标签

### 5. 金额计算策略
- **基础金额计算：**
  - 订单总金额减去运费（默认）
  - 可自定义计算方式
- **精度控制：** 支持自定义小数位数（0-4位）
- **最小金额限制：** 设置最小分账金额门槛
- **尾数处理策略：**
  - none：不处理
  - largest：分配给最大分账方
  - first：分配给第一个分账方
  - receiver：分配给指定收款方

## 安装和配置

### 安装步骤

1. 确保已安装并启用 WooCommerce 和 Woo Alipay 插件
2. 将插件文件上传到 `/wp-content/plugins/` 目录
3. 在 WordPress 后台启用插件
4. 进入 WooCommerce → 设置 → Alipay Profit Sharing 进行配置

### 基础配置

#### 1. 通用设置
- **执行策略：** 选择延迟结算或即时结算
- **处理模式：** 选择队列模式或同步模式
- **金额精度：** 设置分账金额的小数位数
- **最小分账金额：** 设置触发分账的最小金额
- **外部请求号前缀：** 自定义分账请求的前缀标识

#### 2. 收款方配置
1. 点击"收款方管理"标签
2. 添加收款方信息：
   - 标签：收款方的识别名称
   - 账号：支付宝账号或用户ID
   - 身份类型：选择登录账号或用户ID
   - 状态：启用或禁用

#### 3. 分账规则设置
1. **默认规则：**
   - 为每个收款方设置默认分账比例
   - 确保总比例不超过100%

2. **分类规则：**
   - 选择商品分类
   - 为该分类设置特定分账规则
   - 可覆盖默认规则

3. **商品规则：**
   - 搜索并选择具体商品
   - 为单个商品设置精细化分账规则
   - 优先级最高

## 管理界面

### 1. 主设置页面 (`WooCommerce → Alipay Profit Sharing`)
- 通用配置选项
- 收款方管理
- 分账规则设置
- 结算查询工具

### 2. 任务管理页面 (`WooCommerce → Alipay Profit Sharing Jobs`)
- 查看所有分账任务状态
- 任务状态包括：待处理、处理中、成功、失败
- 支持任务重试和清理
- 导出任务报表

### 3. 订单页面集成
- 在订单详情页面显示分账状态
- 手动触发分账操作
- 查看分账结果和错误信息
- 支持新一轮分账

## 工作流程

### 自动分账流程

1. **延迟结算模式：**
   ```
   订单完成 → 触发分账任务 → 加入队列/同步处理 → 调用支付宝API → 确认结果
   ```

2. **即时结算模式：**
   ```
   支付完成 → 触发分账任务 → 加入队列/同步处理 → 调用支付宝API → 确认结果
   ```

### 手动分账流程
1. 进入订单详情页面
2. 点击"手动分账"按钮
3. 系统计算分账金额
4. 执行分账操作
5. 显示结果状态

## 任务状态说明

- **pending：** 待处理
- **processing：** 处理中
- **succeeded：** 成功
- **failed：** 失败

## 错误处理

### 常见错误类型
- `ACQ.SYSTEM_ERROR`：网关系统繁忙，请稍后重试
- `ACQ.INVALID_PARAMETER`：参数不正确，请检查身份信息与金额格式
- `ACQ.ACCESS_FORBIDDEN`：无权限调用接口，请检查商户资质与授权
- `ACQ.TRADE_NOT_EXIST`：交易不存在，请确认 trade_no 是否正确
- `ACQ.PAYMENT_INFO_INCONSISTENT`：交易信息不一致，请检查金额与订单信息

### 错误处理机制
- 自动重试机制（可配置重试次数）
- 详细的错误日志记录
- 管理员错误通知
- 失败任务手动重试

## 退款补偿

当订单发生退款时，插件会自动：
1. 计算需要补偿的分账金额
2. 生成分账建议
3. 管理员可手动执行补偿操作

## 确认机制

分账请求发送后，插件会：
1. 定期查询分账结果
2. 自动确认分账状态
3. 可配置确认间隔和最大查询次数

## 数据存储

插件使用 WordPress 的 `options` 表存储：
- `woo_alipay_ps_settings`：插件设置
- `woo_alipay_ps_receivers`：收款方信息
- `woo_alipay_ps_rules`：分账规则
- `woo_alipay_ps_jobs`：任务队列

## 安全特性

- 权限验证：只有具备相应权限的用户才能操作
- 数据验证：所有输入数据都经过严格验证
- 安全检查：防止SQL注入和XSS攻击
- 操作日志：记录所有关键操作

## 日志记录

插件使用 WooCommerce 的日志系统：
- 日志标识：`alipay_profitsharing`
- 记录级别：debug、info、warning、error
- 日志内容：API请求、响应、错误信息等

## 性能优化

- 队列处理避免阻塞前端操作
- 批量处理提高效率
- 智能重试机制
- 任务状态缓存

## 扩展接口

插件提供以下钩子供开发者扩展：
- `woo_alipay_ps_run_job`：任务执行钩子
- `woo_alipay_ps_process_jobs`：批量处理钩子
- 各种管理操作的前后钩子

## 常见问题

### Q: 分账失败怎么办？
A: 检查收款方信息是否正确，确认支付宝账户资质，查看错误日志了解具体原因。

### Q: 如何修改已完成的分账？
A: 使用"新一轮分账"功能，清除原有标记后重新分账。

### Q: 分账金额计算不准确？
A: 检查金额精度设置、尾数处理策略和最小金额限制。

### Q: 队列任务不执行？
A: 确认WP-Cron正常运行，或安装Action Scheduler插件。

## 技术支持

- 官方网站：https://woocn.com/
- 文档地址：https://woocn.com/docs/
- 支持邮箱：support@woocn.com

## 更新日志

### v0.1.0
- 初始版本发布
- 支持基本的支付宝分账功能
- 提供完整的管理界面
- 支持延迟和即时结算模式

## 许可证

本插件遵循 GPL v2.0 或更高版本许可证。